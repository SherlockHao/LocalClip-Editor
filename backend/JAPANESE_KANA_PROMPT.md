# 日语翻译特殊处理：使用假名

## 修改说明

针对日语翻译，在 Prompt 中添加了"使用假名"的特殊要求。

---

## 代码位置

**文件**：[batch_retranslate_ollama.py](batch_retranslate_ollama.py#L152-L157)

**函数**：`translate_sentence()`

---

## 修改内容

### 修改前

```python
prompt = f'请将以下中文翻译成{target_language}（口语化、极简），以 JSON 格式输出，Key 为 "tr"：\n\n{sentence}'
```

### 修改后

```python
# 针对日语添加特殊要求：使用假名
if '日' in target_language or 'ja' in target_language.lower():
    prompt = f'请将以下中文翻译成{target_language}（口语化、极简、使用假名），以 JSON 格式输出，Key 为 "tr"：\n\n{sentence}'
else:
    prompt = f'请将以下中文翻译成{target_language}（口语化、极简），以 JSON 格式输出，Key 为 "tr"：\n\n{sentence}'
```

---

## 触发条件

当 `target_language` 满足以下任一条件时，会添加"使用假名"要求：

1. 包含"日"字（如："日语"、"日文"）
2. 包含"ja"（不区分大小写，如："ja"、"JA"、"Japanese"）

---

## 效果对比

### 日语翻译 Prompt

```
请将以下中文翻译成日语（口语化、极简、使用假名），以 JSON 格式输出，Key 为 "tr"：

今天天气真好
```

**预期输出**：
```json
{"tr": "きょうはほんとうにいいてんきですね"}
```

### 英语翻译 Prompt（对比）

```
请将以下中文翻译成英语（口语化、极简），以 JSON 格式输出，Key 为 "tr"：

今天天气真好
```

**预期输出**：
```json
{"tr": "The weather is really nice today"}
```

---

## 为什么需要"使用假名"？

### 1. 语音合成友好

假名（平假名/片假名）的发音完全确定，TTS 系统能够准确发音。

**对比**：
- 汉字"今日"：可能读作"きょう"或"こんにち"，TTS 难以选择
- 假名"きょう"：发音唯一确定

### 2. 符合口语化要求

日常日语对话中，假名使用频率远高于汉字。

**示例**：
| 中文 | 书面语（汉字） | 口语（假名） |
|-----|--------------|------------|
| 吃饭 | 食事する | ごはんをたべる |
| 漂亮 | 綺麗だ | きれいだ |
| 很好 | 大変良い | とてもいい |

### 3. 减少歧义

同一个汉字在日语中可能有多种读音（音读/训读），使用假名避免歧义。

**示例**：
| 汉字 | 可能读音 | 假名（唯一） |
|-----|---------|------------|
| 今日 | きょう / こんにち | きょう |
| 明日 | あした / みょうにち / あす | あした |
| 一人 | ひとり / いちにん | ひとり |

---

## 测试验证

运行测试脚本：

```bash
cd backend
python test_japanese_prompt.py
```

**测试覆盖**：
- ✅ "日语" → 包含"使用假名"
- ✅ "日文" → 包含"使用假名"
- ✅ "ja" → 包含"使用假名"
- ✅ "JA" → 包含"使用假名"
- ✅ "Japanese" → 包含"使用假名"
- ✅ "英语" → 不包含"使用假名"
- ✅ "韩语" → 不包含"使用假名"

---

## 日语汉字检测（新增功能）

### 检测逻辑

**位置**：[main.py:915-921](main.py#L915-L921)

在验证译文时，除了检查长度，还会检测日语译文中是否包含汉字：

```python
# 日语特殊规则：如果译文中包含汉字，需要重新翻译（要求使用假名）
if not needs_retranslation:
    target_language_lower = target_language.lower()
    is_japanese = ('日' in target_language or 'ja' in target_language_lower)
    if is_japanese and contains_chinese_characters(target_text):
        needs_retranslation = True
        print(f"  [日语检查] 第 {idx} 条译文包含汉字，需要重新翻译: '{target_text}'")
```

### 检测函数

**位置**：[text_utils.py:92-107](text_utils.py#L92-L107)

```python
def contains_chinese_characters(text: str) -> bool:
    """
    检测文本中是否包含中文字（汉字）

    注意：此函数检测CJK统一汉字，日文中也使用汉字，但比例较低。
    主要用于检测日文翻译中是否有过多汉字（应该用假名代替）。
    """
    # CJK统一汉字 Unicode 范围: 0x4E00-0x9FFF
    return bool(re.search(r'[\u4e00-\u9fff]', text))
```

### 触发重新翻译的条件

对于日语翻译，满足以下**任一条件**即会触发重新翻译：

1. ❌ **译文超长**（长度超过原文2.5倍）
   - 日语使用假名，字符数比汉字多，因此放宽到2.5倍
   - 韩语使用谚文，同样放宽到2.5倍
   - 其他语言（英语等）使用1.2倍限制
2. ❌ **包含汉字**（译文中检测到CJK统一汉字）

### 示例场景

| 原文 | 初始译文 | 包含汉字？ | 是否重新翻译 | 重新翻译后 |
|-----|---------|----------|------------|----------|
| 你好 | こんにちは | ❌ | 不需要 | - |
| 今天 | 今日 | ✅ | **需要** | きょう |
| 吃饭 | 食事をする | ✅ | **需要** | ごはんをたべる |
| 漂亮 | きれい | ❌ | 不需要 | - |
| 很好 | とてもいい | ❌ | 不需要 | - |
| 天气好 | 天気がいい | ✅ | **需要** | てんきがいい |

---

## 影响范围

此修改影响以下场景的日语翻译：

1. **批量重新翻译**（语音克隆过程中）
   - 检测到超长译文时自动重新翻译
   - 检测到包含汉字的译文时自动重新翻译
   - 使用 Ollama qwen3:4b 模型
   - Prompt 包含"使用假名"要求

2. **单条翻译**（用户修改原文后）
   - 前端调用 `/api/translate-text`
   - 重新生成单条译文
   - Prompt 包含"使用假名"要求

---

## 总结

### ✅ 已实现的日语特殊处理

1. **Prompt 优化**：日语翻译自动添加"使用假名"要求
2. **汉字检测**：自动检测译文中的汉字，触发重新翻译
3. **双重验证**：长度检查 + 汉字检查，确保译文质量

### 🎯 效果

- ✅ **自动触发**：系统自动识别日语，无需额外配置
- ✅ **质量提升**：假名翻译更适合口语化和语音合成
- ✅ **避免汉字**：即使LLM输出了汉字，系统也会自动重新翻译
- ✅ **不影响其他语言**：英语、韩语等其他语言保持原有逻辑

### 📋 文件清单

| 文件 | 修改内容 | 状态 |
|-----|---------|------|
| `batch_retranslate_ollama.py` | Prompt添加"使用假名" | ✅ 已修改 |
| `text_utils.py` | 新增`contains_chinese_characters()` | ✅ 已修改 |
| `main.py` | 添加日语汉字检测逻辑 | ✅ 已修改 |
| `test_japanese_kanji_detection.py` | 汉字检测测试 | ✅ 已创建 |
